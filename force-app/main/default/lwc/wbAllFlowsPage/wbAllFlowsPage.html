<template>

    <template if:true={showLicenseError}>
        <c-license-expired-l-w-c onpackageupdate={handlePackageUpdate}></c-license-expired-l-w-c>
    </template>
    <template if:false={showLicenseError}>
        <template if:false={isNameClicked}>
            <template if:true={isFlowVisible}>
                <div class="slds-theme_default main">
                    <template if:true={isLoading}>
                        <div class="spinner-overlay">
                            <lightning-spinner alternative-text="Loading" size="large"></lightning-spinner>
                        </div>
                    </template>
                    <div class="slds-grid slds-grid_vertical">
                        <div class="heading">
                            <p class="txt">WhatsApp Flows</p>
                        </div>

                            <!-- <div class="filterdiv">
                                <lightning-input variant="label-hidden" class="filter search-div" type="search"
                                    placeholder="Search Name" onchange={handleSearchInputChange}></lightning-input>
                                <lightning-combobox variant="label-hidden" class="filter" value={statusValues}
                                    placeholder="Status" options={statusOptions}
                                    onchange={handleStatusChange}></lightning-combobox>
                            </div> -->


                        <div class="filterparent">
                            <div class="filterdiv">
                                <div class="search-container">
                                    <div class="search-icon">
                                        <lightning-icon icon-name="utility:search" size="x-small"></lightning-icon>
                                    </div>
                                    <input type="search" class="slds-input" name="searchInput" placeholder="Search Name"
                                        onkeyup={handleSearchInputChange} />
                                </div>

                                <div class="custom-status-select">
                                    <select class="filter" value={statusValues} onchange={handleStatusChange}>
                                        <option value="All" selected>All</option>
                                        <template for:each={statusOptions} for:item="opt">
                                            <option key={opt.value} value={opt.value}>{opt.label}</option>
                                        </template>
                                    </select>
                                </div>

                            </div>

                            <div class="btns">
                                <button class="custom-button cus-btns" onclick={showCreateFlow}>
                                    <lightning-icon icon-name="utility:add" alternative-text="Add" size="x-small"
                                        class="left-icon"></lightning-icon>
                                    <span>Create Flow</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="slds-m-around_medium table-container">
                        <template if:true={paginatedData.length}>
                            <table class="slds-table">
                                <thead>
                                    <tr class="tablerow">
                                        <th class="tableHead" scope="col">
                                            <div class="slds-truncate">No.</div>
                                        </th>
                                        <th class="tableHead" scope="col">
                                            <div class="slds-truncate">Flow Name</div>
                                        </th>
                                        <th class="tableHead" scope="col">
                                            <div class="slds-truncate">Flow ID</div>
                                        </th>
                                        <th class="tableHead" scope="col">
                                            <div class="slds-truncate">Status</div>
                                        </th>
                                        <th class="tableHead" scope="col">
                                            <div class="slds-truncate">Last Updated</div>
                                        </th>
                                        <th class="tableHead" scope="col">
                                            <div class="slds-truncate">Actions</div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template for:each={paginatedData} for:item="record">
                                        <tr class="tablerow" key={record.id}>
                                            <td class="tableData" data-label="Sr. No.">
                                                <div class="slds-truncate">{record.serialNumber}</div>
                                            </td>
                                            <td class="tableData" data-label="Flow Name" title={record.MVWB__Flow_Name__c}>
                                                <a href="javascript:void(0);" class="truncate-name" data-record-id={record.MVWB__Flow_Id__c} onclick={handleNameClick}>{record.MVWB__Flow_Name__c}</a>
                                            </td>
                                            <td class="tableData" data-label="Flow ID">
                                                <div class="slds-truncate">{record.MVWB__Flow_Id__c}</div>
                                            </td>
                                            <td class="tableData" data-label="Status">
                                                <div class="slds-truncate">
                                                    <p class={record.MVWB__Status__c}>{record.MVWB__Status__c}</p>
                                                </div>
                                            </td>
                                            <td class="tableData status" data-label="LastModifiedDate">
                                                <div class="slds-truncate">{record.LastModifiedDate}</div>
                                            </td>
                                            <td class="tableData tablebtns" data-label="Actions">
                                                <div class="action-container" data-id="record.MVWB__Flow_Id__c">
                                                    <button class="action-button" onclick={toggleDropdown}>
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="4" height="17" viewBox="0 0 4 17" fill="none">
                                                            <path d="M1.99992 13.801C2.38335 13.801 2.75107 13.9533 3.0222 14.2245C3.29332 14.4956 3.44564 14.8633 3.44564 15.2467C3.44564 15.6302 3.29332 15.9979 3.0222 16.269C2.75107 16.5401 2.38335 16.6925 1.99992 16.6925C1.61649 16.6925 1.24877 16.5401 0.977641 16.269C0.706515 15.9979 0.554199 15.6302 0.554199 15.2467C0.554199 14.8633 0.706515 14.4956 0.977641 14.2245C1.24877 13.9533 1.61649 13.801 1.99992 13.801ZM1.99992 7.05431C2.38335 7.05431 2.75107 7.20663 3.0222 7.47775C3.29332 7.74888 3.44564 8.11661 3.44564 8.50003C3.44564 8.88346 3.29332 9.25119 3.0222 9.52231C2.75107 9.79344 2.38335 9.94575 1.99992 9.94575C1.61649 9.94575 1.24877 9.79344 0.977641 9.52231C0.706515 9.25119 0.554199 8.88346 0.554199 8.50003C0.554199 8.11661 0.706515 7.74888 0.977641 7.47775C1.24877 7.20663 1.61649 7.05431 1.99992 7.05431ZM1.99992 0.307617C2.38335 0.307617 2.75107 0.459934 3.0222 0.731059C3.29332 1.00218 3.44564 1.36991 3.44564 1.75334C3.44564 2.13677 3.29332 2.50449 3.0222 2.77562C2.75107 3.04674 2.38335 3.19906 1.99992 3.19906C1.61649 3.19906 1.24877 3.04674 0.977641 2.77562C0.706515 2.50449 0.554199 2.13677 0.554199 1.75334C0.554199 1.36991 0.706515 1.00218 0.977641 0.731059C1.24877 0.459934 1.61649 0.307617 1.99992 0.307617Z" fill="black"/>
                                                        </svg>
                                                    </button>
                                                    <div class="dropdown-menu hidden" data-id={record.MVWB__Flow_Id__c}>
                                                        <template if:false={record.isDeprecated}>
                                                            <div class="dropdown-item" onclick={previewTemplate} data-id={record.MVWB__Flow_Id__c}>Preview</div>
                                                        </template>
                                                        <template if:true={record.isEditable}>
                                                            <div class="dropdown-item" onclick={editFlow} data-id={record.MVWB__Flow_Id__c} data-status={record.MVWB__Status__c}>Edit</div>
                                                        </template>
                                                        <div class="dropdown-item" onclick={cloneFlow} data-id={record.MVWB__Flow_Id__c}>Clone</div>
                                                        <template if:true={record.isPublished}>
                                                            <div class="dropdown-item" onclick={confirmDeprecateFlow} data-id={record.MVWB__Flow_Id__c} data-status={record.MVWB__Status__c}>Deprecate</div>
                                                        </template>
                                                        <template if:true={record.isDraft}>
                                                            <div class="dropdown-item" onclick={confirmDeleteFlow} data-id={record.MVWB__Flow_Id__c} data-status={record.MVWB__Status__c}>Delete</div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>

                            </table>
                        </template>
                        <template if:true={showNoRecordsMessage}>
                            <div class="no-records-message">
                                <div class="empty-state">
                                    <div class="empty-state__content">
                                        <div class="empty-state__icon">
                                            <img src="/resource/MVWB__emptyState" alt="" draggable="false">
                                        </div>
                                        <div class="empty-state__message">No Data Available to Show.</div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                    <template if:true={paginatedData.length}>
                        <div class="pagination-container">
                            <button class="pagination-button" disabled={isFirstPage} onclick={handlePrevious}>
                                <svg xmlns="http://www.w3.org/2000/svg" height="52" width="52" viewBox="0 0 520 520"
                                    fill="#fff">
                                    <path
                                        d="M342 477 134 272c-6-6-6-16 0-22L342 45c6-6 16-6 22 0l22 22c6 6 6 16 0 22L221 250c-6 6-6 16 0 22l163 161c6 6 6 16 0 22l-22 22c-5 5-14 5-20 0z" />
                                </svg>
                                Previous
                            </button>

                            <template for:each={pageNumbers} for:item="page">
                                <template if:false={page.isEllipsis}>
                                    <button key={page.number} data-id={page.number} class={page.className}
                                        onclick={handlePageChange}>
                                        {page.number}
                                    </button>
                                </template>
                                <template if:true={page.isEllipsis}>
                                    <span key={page.number} class="pagination-ellipsis">...</span>
                                </template>
                            </template>

                            <button class="pagination-button" disabled={isLastPage} onclick={handleNext}>
                                Next
                                <svg xmlns="http://www.w3.org/2000/svg" height="52" width="52" viewBox="0 0 520 520"
                                    fill="#fff">
                                    <path
                                        d="m179 44 207 205c6 6 6 16 0 22L179 476c-6 6-16 6-22 0l-22-22c-6-6-6-16 0-22l163-161c6-6 6-16 0-22L136 88c-6-6-6-16 0-22l22-22c6-5 15-5 21 0z" />
                                </svg>
                            </button>
                        </div>
                    </template>

                    <template if:true={showPopup}>
                        <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true"
                            aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open">
                            <div class="slds-modal__container preview-container">
                                <div class="slds-modal__content slds-p-around_medium flow-preview" id="modal-content-id-2">
                                    <p class="preview-heading">Flow Preview</p>
                                    <template if:true={isFlowDraft}>
                                        <div class="slds-text-align--right slds-m-horizontal--medium slds-m-top--medium">
                                            <button class="publish-btn" onclick={publishFlow}>Publish Flow</button>
                                        </div>
                                    </template>
                                    <div class="previewContainer slds-m-top--medium">
                                        <iframe class="flowIframe" src={flowPreviewURL} width="430" height="800"></iframe>
                                    </div>
                                    <div class="footer">
                                        <button class="close-btn" onclick={closePopup}>Close</button>
                                    </div>
                                </div>
                            </div>
                        </section>
                        <div class="slds-backdrop slds-backdrop_open" onclick={closePopup}></div>
                    </template>
                </div>
            </template>
            <template if:true={iscreateflowvisible}>
                <c-create-flow-management is-edit-mode={isEditMode} is-clone-flow={isCloneFlow} selected-flow-id={selectedFlowId} clone-flow-name={cloneFlowName}></c-create-flow-management>
            </template>

            <!-- Delete Flow Modal -->
            <template if:true={showDeletePopup}>
                <div class="edit-backdrop" onclick={closeDeprecatePopup}></div>
                <div class="edit-popup">
                    <div class="edit-popup-content">
                        <h2 class="edit-popup-title">Are you sure you want to delete this flow?</h2>
                        <p class="edit-popup-text">
                            Once deleted, you won't be able to access this flow again. This cannot be undone.
                        </p>
                        <div class="edit-button-group">
                            <button class="edit-cancel-button" onclick={closeDeprecatePopup}>Cancel</button>
                            <button class="edit-delete-button" onclick={deleteFlow}>Delete</button>
                        </div>
                    </div>
                </div>
            </template>
            
            <!-- Deprecate Flow Modal -->
            <template if:true={showDeprecatePopup}>
                <div class="edit-backdrop" onclick={closeDeprecatePopup}></div>
                <div class="edit-popup">
                    <div class="edit-popup-content">
                        <h2 class="edit-popup-title">Are you sure you want to deprecate this flow?</h2>
                        <p class="edit-popup-text">
                            Once deprecated, you won't be able to revert. This cannot be undone.
                        </p>
                        <div class="edit-button-group">
                            <button class="edit-cancel-button" onclick={closeDeprecatePopup}>Cancel</button>
                            <button class="edit-delete-button" onclick={deprecateFlow}>Deprecate</button>
                        </div>
                    </div>
                </div>
            </template>

            <!-- Clone Modal -->
            <template if:true={showCloneModal}>
                <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open">
                    <div class="slds-modal__container modal-container">
                        <header>
                            <h2 class="modal-header">Clone Flow</h2>
                        </header>
                        <div class="slds-modal__content slds-p-around_medium modal-content">
                            <lightning-input 
                                label="Enter New Flow name"
                                value={cloneFlowName}
                                onchange={handleFlowNameChange}>
                            </lightning-input>
                        </div>
                        <footer class="slds-modal__footer modal-footer">
                            <lightning-button variant="brand-outline" onclick={closeCloneModal} label="Cancel" class="slds-m-left_x-small"></lightning-button>
                            <lightning-button variant="brand" label="Next" onclick={handleCloneNext} disabled={isDisabledCloneNext} class="slds-m-left_x-small"></lightning-button>
                        </footer>
                    </div>
                </section>
                <div class="slds-backdrop slds-backdrop_open"></div>
            </template>
        </template>
        <template if:true={isNameClicked}>
            <c-wb-flows-report selected-flow-id={selectedFlowId} selected-flow-name={selectedFlowName}></c-wb-flows-report>
        </template>
    </template>
</template>